<!-- templates/advanced_report.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto p-4">
    <h2 class="text-2xl font-bold mb-6 text-right">📊 گزارش پیشرفته اعضا</h2>

    <!-- فیلترها -->
    <form method="GET" class="bg-white p-6 rounded shadow mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-right mb-4">
            <!-- فیلتر باشگاه -->
            <div>
                <label class="block mb-2 text-sm font-medium">باشگاه</label>
                <select name="club_id" id="clubSelect" class="w-full border rounded px-3 py-2 text-right" onchange="loadSessions(this.value)">
                    <option value="">همه باشگاه‌ها</option>
                    {% for c in clubs %}
                    <option value="{{ c.club_id }}" {% if club_filter == c.club_id|string %}selected{% endif %}>
                        {{ c.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- فیلتر سانس -->
            <div>
                <label class="block mb-2 text-sm font-medium">سانس</label>
                <select name="session_id" id="sessionSelect" class="w-full border rounded px-3 py-2 text-right" {% if not club_filter %}disabled{% endif %}>
                    <option value="">همه سانس‌ها</option>
                    {% if club_filter %}
                        {% for s in sessions %}
                            {% if s.club_id|string == club_filter %}
                            <option value="{{ s.session_id }}" {% if session_filter == s.session_id|string %}selected{% endif %}>
                                {{ s.coach_name }} - {{ s.class_time }}
                            </option>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <option value="">ابتدا باشگاه را انتخاب کنید</option>
                    {% endif %}
                </select>
            </div>

            <!-- فیلتر کمربند -->
            <div>
                <label class="block mb-2 text-sm font-medium">کمربند</label>
                <select name="belt" class="w-full border rounded px-3 py-2 text-right">
                    <option value="">همه کمربندها</option>
                    {% for b in belts %}
                    <option value="{{ b }}" {% if belt_filter == b %}selected{% endif %}>{{ b }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- فیلتر بیمه -->
            <div>
                <label class="block mb-2 text-sm font-medium">وضعیت بیمه</label>
                <select name="insurance" class="w-full border rounded px-3 py-2 text-right">
                    <option value="">همه وضعیت‌ها</option>
                    <option value="expired" {% if insurance_filter == 'expired' %}selected{% endif %}>منقضی شده</option>
                    <option value="10days" {% if insurance_filter == '10days' %}selected{% endif %}>تا ۱۰ روز آینده منقضی می‌شود</option>
                </select>
            </div>
        </div>

        <div class="flex space-x-4 space-x-reverse justify-start">
            <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">اعمال فیلتر</button>
            <a href="{{ url_for('reports.advanced_report') }}" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">حذف فیلتر</a>
        </div>
    </form>

    <!-- دکمه پرینت -->
    <div class="text-center mb-4">
        <button onclick="window.print()" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
            🖨️ پرینت گزارش
        </button>
    </div>

    <!-- نمایش خطا -->
    {% if error %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <strong>خطا:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- جدول گزارش -->
    <div class="overflow-x-auto bg-white rounded shadow">
        <table class="w-full text-right">
            <thead class="bg-gray-200">
                <tr>
                    <th class="p-3 border">نام و نام خانوادگی</th>
                    <th class="p-3 border">کد ملی</th>
                    <th class="p-3 border">شماره تلفن</th>
                    <th class="p-3 border">کمربند</th>
                    <th class="p-3 border">باشگاه</th>
                    <th class="p-3 border">سانس</th>
                    <th class="p-3 border">تاریخ تولد</th>
                    <th class="p-3 border">تاریخ بیمه</th>
                    <th class="p-3 border">وضعیت بیمه</th>
                </tr>
            </thead>
            <tbody>
                {% for m in members %}
                <tr class="border-t hover:bg-gray-50">
                    <td class="p-3 border">{{ m.name }} {{ m.family_name }}</td>
                    <td class="p-3 border">{{ m.national_id }}</td>
                    <td class="p-3 border">{{ m.phone or '-' }}</td>
                    <td class="p-3 border">{{ m.belt or '-' }}</td>
                    <td class="p-3 border">{{ m.club_name or '-' }}</td>
                    <td class="p-3 border">{{ m.session_name or '-' }}</td>
                    <td class="p-3 border">{{ m.birth_date_jalali }}</td>
                    <td class="p-3 border">{{ m.insurance_date_jalali or '-' }}</td>
                    <td class="p-3 border">
                        {% if m.insurance_status == 'valid' %}
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">فعال</span>
                        {% elif m.insurance_status == 'expired' %}
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">منقضی</span>
                        {% elif m.insurance_status == 'soon' %}
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm">به زودی</span>
                        {% else %}
                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm">نامشخص</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- اگر هیچ رکوردی وجود نداشت -->
    {% if not members %}
    <div class="text-center py-12 text-gray-500 bg-white rounded shadow mt-4">
        <div class="text-4xl mb-4">📊</div>
        <p class="text-lg">هیچ داده‌ای برای نمایش وجود ندارد.</p>
        {% if club_filter or session_filter or belt_filter or insurance_filter %}
        <p class="text-sm mt-2">می‌توانید فیلترها را تغییر دهید یا <a href="{{ url_for('reports.advanced_report') }}" class="text-blue-500">همه اعضا را ببینید</a></p>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// تابع برای بارگذاری سانس‌های یک باشگاه
function loadSessions(clubId) {
    const sessionSelect = document.getElementById('sessionSelect');
    
    if (!clubId) {
        sessionSelect.innerHTML = '<option value="">ابتدا باشگاه را انتخاب کنید</option>';
        sessionSelect.disabled = true;
        return;
    }
    
    // نمایش loading
    sessionSelect.innerHTML = '<option value="">در حال بارگذاری سانس‌ها...</option>';
    sessionSelect.disabled = false;
    
    // درخواست AJAX برای دریافت سانس‌های باشگاه انتخاب شده
    fetch(`/reports/api/sessions/${clubId}`)
        .then(response => {
            if (!response.ok) throw new Error('خطا در دریافت سانس‌ها');
            return response.json();
        })
        .then(sessions => {
            if (sessions.length === 0) {
                sessionSelect.innerHTML = '<option value="">هیچ سانسی برای این باشگاه وجود ندارد</option>';
            } else {
                sessionSelect.innerHTML = '<option value="">همه سانس‌ها</option>';
                sessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.session_id;
                    option.textContent = `${session.coach_name} - ${session.class_time}`;
                    sessionSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('خطا در بارگذاری سانس‌ها:', error);
            sessionSelect.innerHTML = '<option value="">خطا در بارگذاری سانس‌ها</option>';
        });
}

// بارگذاری اولیه اگر باشگاه از قبل انتخاب شده
document.addEventListener('DOMContentLoaded', function() {
    const clubSelect = document.getElementById('clubSelect');
    if (clubSelect.value) {
        loadSessions(clubSelect.value);
    }
});
</script>

<!-- استایل مخصوص پرینت -->
<style>
@media print {
    nav, form, button, .bg-gray-200 th { 
        display: none !important; 
    }
    body { 
        background: white !important; 
        font-size: 12px;
    }
    .container {
        padding: 0 !important;
        margin: 0 !important;
        width: 100% !important;
    }
    table { 
        width: 100% !important; 
        border-collapse: collapse;
    }
    th, td { 
        border: 1px solid #000 !important; 
        padding: 6px;
        text-align: right;
    }
    th {
        background-color: #f0f0f0 !important;
    }
}
</style>
{% endblock %}